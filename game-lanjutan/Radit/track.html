<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Location Consent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark light; }
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(circle at top, #4f46e5 0, #020617 45%, #000 100%);
      color:#e5e7eb; padding:24px;
    }
    .card{
      background: rgba(15, 23, 42, 0.95);
      border-radius: 16px;
      padding: 1.5rem 1.75rem;
      max-width: 560px; width:100%;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }
    .badge{
      display:inline-flex; align-items:center; gap:.4rem;
      font-size:.72rem; padding:.18rem .5rem; border-radius:999px;
      background: rgba(34, 197, 94, 0.10);
      color: #bbf7d0;
      border: 1px solid rgba(34, 197, 94, 0.35);
      margin-bottom:.6rem;
    }
    .dot{ width:7px; height:7px; border-radius:999px; background:#22c55e; }
    h1{ margin:0 0 .5rem; font-size:1.25rem; }
    p{ margin:.35rem 0; font-size:.92rem; color:#9ca3af; line-height:1.45; }
    .hint{ margin-top:.6rem; font-size:.8rem; color:#6b7280; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button,a.btn{
      padding:10px 12px; border-radius:12px;
      border:1px solid rgba(99, 102, 241, 0.35);
      background: rgba(99, 102, 241, 0.18);
      color:#e5e7eb; font-weight:800; font-size:.9rem;
      cursor:pointer; text-decoration:none;
      display:inline-flex; align-items:center; justify-content:center;
    }
    button.primary{ background: rgba(99, 102, 241, 0.28); }
    .status{
      margin-top: 1rem; padding: .75rem; border-radius: .75rem;
      background: rgba(2, 6, 23, 0.35);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: .78rem; max-height: 220px; overflow:auto;
      border: 1px solid rgba(55, 65, 81, 0.8);
      white-space: pre-wrap; word-break: break-word;
    }
    code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
  </style>
</head>
<body>
  <div class="card">
    <div class="badge"><span class="dot"></span> Location Consent</div>

    <h1>Izinkan lokasi untuk melanjutkan</h1>
    <p>
      Halaman ini akan meminta izin lokasi dan menyimpan koordinat ke database (Supabase), lalu mengalihkan ke tujuan.
    </p>
    <p id="dest" class="hint"></p>

    <div class="row">
      <button id="start" class="primary">Mulai</button>
      <a class="btn" href="./">Home</a>
      <a class="btn" href="./log.html">Log</a>
    </div>

    <div id="status" class="status">Ready.</div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    const statusEl = document.getElementById("status");
    const destEl = document.getElementById("dest");

    function log(msg){
      statusEl.textContent += "\n" + msg;
      statusEl.scrollTop = statusEl.scrollHeight;
    }

    // ==============================================
    const SUPABASE_URL = "https://yfwnfaocsswqerhgxkto.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlmd25mYW9jc3N3cWVyaGd4a3RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNjE3MTksImV4cCI6MjA4MDgzNzcxOX0.8ADF4wgcEv_lI2qOPcDt1OujckrIBoDYE52wIE8YZEM";
    // ==============================================
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function getRedirectUrl(){
      const u = new URL(location.href);
      const to = u.searchParams.get("to");
      if (to) { try { return new URL(to).toString(); } catch { return null; } }

      const saved = localStorage.getItem("tracker_redirect");
      if (saved) { try { return new URL(saved).toString(); } catch { return null; } }

      return null;
    }

    const REDIRECT_URL = getRedirectUrl();

    destEl.innerHTML = REDIRECT_URL
      ? `Tujuan redirect: <code>${REDIRECT_URL}</code>`
      : `Tujuan redirect belum diset. Kembali ke <a href="./" style="color:#c7d2fe;text-decoration:none">Home</a> untuk set.`;

    async function sendLocation(){
      if (!REDIRECT_URL){
        log("Tidak ada redirect URL. Set dulu di Home atau pakai ?to=https://...");
        return;
      }

      if (!navigator.geolocation){
        log("Geolocation tidak didukung di browser ini.");
        return;
      }

      log("Meminta izin lokasi dari browser...");

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const payload = {
            lat: pos.coords.latitude,
            lon: pos.coords.longitude,
            accuracy: pos.coords.accuracy,
            user_agent: navigator.userAgent
          };

          log("Lokasi didapat:");
          log(JSON.stringify(payload, null, 2));
          log("Menyimpan ke Supabase...");

          const { data, error } = await client
            .from("locations")
            .insert(payload)
            .select();

          if (error){
            log("Gagal simpan ke Supabase: " + error.message);
            return;
          }

          log("Berhasil simpan.");
          log("Redirect...");
          setTimeout(() => window.location.href = REDIRECT_URL, 800);
        },
        (err) => log("Gagal ambil lokasi: " + err.message),
        { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
      );
    }

    document.getElementById("start").addEventListener("click", () => {
      statusEl.textContent = "Inisialisasi...";
      sendLocation();
    });
  </script>
</body>
</html>
