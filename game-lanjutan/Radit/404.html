<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Redirect…</title>
  <style>
    :root{color-scheme:dark light}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#4f46e5 0,#020617 45%,#000 100%);color:#e5e7eb;padding:24px}
    .card{max-width:560px;width:100%;background:rgba(15,23,42,.92);border:1px solid rgba(148,163,184,.25);
      border-radius:16px;padding:16px;box-shadow:0 25px 60px rgba(0,0,0,.6)}
    .muted{color:#9ca3af;font-size:.92rem;line-height:1.45}
    code{font-family:ui-monospace,Menlo,Consolas,monospace}
    a{color:#c7d2fe;text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="card">
    <h2 id="t">Redirect…</h2>
    <p id="d" class="muted">Mencari shortlink…</p>
    <p class="muted">Path: <code id="p"></code></p>
    <p class="muted"><a href="./">Kembali ke Home</a></p>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL = "https://nqsdikmuyrjtddwlkkrv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xc2Rpa211eXJqdGRkd2xra3J2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwODI4MjAsImV4cCI6MjA4MTY1ODgyMH0.5Z-evxtPJuyrylxGYDQyVoHDwqtf4HjZ7nXtb0YE8jU";

    const t = document.getElementById("t");
    const d = document.getElementById("d");
    document.getElementById("p").textContent = location.pathname;

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function extractSlug() {
      // handle only /s/<slug>
      const m = location.pathname.match(/\/s\/([^\/?#]+)/);
      return m ? decodeURIComponent(m[1]) : null;
    }

    async function run(){
      const slug = extractSlug();
      if (!slug){
        t.textContent = "Not found";
        d.textContent = "Format shortlink harus /s/<slug>.";
        return;
      }

      d.textContent = "Slug: " + slug + " (cek database…)";

      const { data, error } = await client
        .from("links")
        .select("url, expires_at")
        .eq("slug", slug)
        .limit(1);

      if (error){
        t.textContent = "Error";
        d.textContent = error.message;
        return;
      }

      const row = (data || [])[0];
      if (!row){
        t.textContent = "Not found";
        d.textContent = "Slug tidak ada di database.";
        return;
      }

      if (row.expires_at){
        const exp = new Date(row.expires_at).getTime();
        if (!Number.isNaN(exp) && Date.now() > exp){
          t.textContent = "Expired";
          d.textContent = "Link ini sudah kadaluarsa.";
          return;
        }
      }

      t.textContent = "Redirect…";
      d.textContent = "Mengalihkan ke: " + row.url;
      setTimeout(() => location.href = row.url, 150);
    }

    run();
  </script>
</body>
</html>
